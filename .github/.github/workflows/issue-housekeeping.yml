name: Issue housekeeping (Task)

on:
  issues:
    types: [opened]

permissions:
  issues: write
  metadata: read
  contents: write

jobs:
  tidy:
    runs-on: ubuntu-latest
    steps:
      - name: Add label, assign, normalize title
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;
            const issue = context.payload.issue;

            // 1) ã‚¿ã‚¤ãƒˆãƒ«ã« [Task] ã‚’ä»˜ã‘ã‚‹ï¼ˆç„¡ã‘ã‚Œã°å…ˆé ­ã«ä»˜ä¸ï¼‰
            const wantPrefix = "[Task] ";
            let newTitle = issue.title;
            if (!issue.title.startsWith(wantPrefix)) {
              newTitle = wantPrefix + issue.title.replace(/^\s*\[Task\]\s*/i, "");
              await github.rest.issues.update({ owner, repo, issue_number, title: newTitle });
            }

            // 2) ãƒ©ãƒ™ãƒ« task ã‚’ä»˜ä¸ï¼ˆç„¡ã‘ã‚Œã°ä½œæˆã—ã¦ã‹ã‚‰ä»˜ä¸ï¼‰
            const labelName = "task";
            async function ensureLabel(name) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (e) {
                // ç„¡ã‘ã‚Œã°ä½œæˆï¼ˆè–„ã„ã‚°ãƒ¬ãƒ¼ï¼‰
                await github.rest.issues.createLabel({ owner, repo, name, color: "ededed", description: "Task item" });
              }
            }
            await ensureLabel(labelName);
            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: [labelName] });

            // 3) ä½œæˆè€…ã‚’è‡ªå‹•ã‚¢ã‚µã‚¤ãƒ³ï¼ˆã™ã§ã«ã‚¢ã‚µã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ç„¡å®³ï¼‰
            const author = issue.user?.login;
            if (author) {
              await github.rest.issues.addAssignees({ owner, repo, issue_number, assignees: [author] });
            }

            // å®Œäº†ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: "ğŸ§¹ è‡ªå‹•æ•´å½¢ï¼šã‚¿ã‚¤ãƒˆãƒ«ãƒ»ãƒ©ãƒ™ãƒ«ãƒ»æ‹…å½“è€…ã‚’è¨­å®šã—ã¾ã—ãŸã€‚"
            });
